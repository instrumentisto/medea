<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <script type="module">
    import init, {
      Jason,
      MediaStreamConstraints, AudioTrackConstraints, VideoTrackConstraints,
    } from './js/medea_jason.js';

    //TODO: add reconnect with backoff, print connection state somewhere
    //     [connected, reconnection, closed]

    let inited = false;
    const controlUrl = document.location.protocol + "//" +
                       document.location.host + "/control-api/";

    async function createRoom(roomId) {
      try {
        let resp = await axios({
          method: 'post',
          url: controlUrl + roomId,
          data: {
            kind: 'Room',
            pipeline: {},
          },
        });
      } catch (e) {
        console.log(e.response);
      }
    }

    async function addNewMember(roomId, memberId) {
      let controlRoom = await axios.get(controlUrl + roomId);
      let anotherMembers = Object.keys(controlRoom.data.element.pipeline);
      let pipeline = {
        publish: {
          kind: 'WebRtcPublishEndpoint',
          p2p: 'Always',
        },
      };

      let memberIds = [];

      for (let i = 0; i < anotherMembers.length; i++) {
        let memberId = anotherMembers[i];
        memberIds.push(memberId);
        pipeline["play-" + memberId] = {
          kind: 'WebRtcPlayEndpoint',
          src: 'local://' + roomId + '/' + memberId + "/publish",
        };
      }

      let resp = await axios({
        method: 'post',
        url: controlUrl + roomId + '/' + memberId,
        data: {
          kind: 'Member',
          credentials: 'test',
          pipeline: pipeline,
        },
      });

      for (let i = 0; i < memberIds.length; i++) {
        let id = memberIds[i];
        await axios({
          method: 'post',
          url: controlUrl + roomId + "/" + id + '/play-' + memberId,
          data: {
            kind: 'WebRtcPlayEndpoint',
            src: 'local://' + roomId + '/' + memberId + '/publish',
          }
        })
      }

      return resp.data.sids[memberId]
    }

    async function init_jason() {
      if (inited) {
        throw Error("Already init");
      }
      await init();
      inited = true;
      const jason = new Jason();

      async function getDevices(audio_select, video_select, current_stream) {
        const current_audio = current_stream.getAudioTracks().pop().label
          || "disable";
        const current_video = current_stream.getVideoTracks().pop().label
          || "disable";
        const device_infos = await jason.media_manager().enumerate_devices();
        console.log('Available input and output devices:', device_infos);
        for (const device_info of device_infos) {
          const option = document.createElement('option');
          option.value = device_info.device_id();
          if (device_info.kind() === 'audio') {
            option.text = device_info.label()
              || `Microphone ${audio_select.length + 1}`;
            option.selected = option.text === current_audio;
            audio_select.append(option);
          } else if (device_info.kind() === 'video') {
            option.text = device_info.label()
              || `Camera ${video_select.length + 1}`;
            option.selected = option.text === current_video;
            video_select.append(option);
          }
        }
      }

      async function getStream(audio_select, video_select) {
        let constraints = new MediaStreamConstraints();
        let audio = new AudioTrackConstraints();
        let audioSource = audio_select.options[audio_select.selectedIndex];
        if (audioSource) {
          audio.device_id(audioSource.value);
        }
        constraints.audio(audio);
        let video = new VideoTrackConstraints();
        let videoSource = video_select.options[video_select.selectedIndex];
        if (videoSource) {
          video.device_id(videoSource.value);
        }
        constraints.video(video);
        return await jason.media_manager().init_local_stream(constraints);
      }

      let chooseRoomDiv = document.getElementById('choose-room');
      let videoCallDiv = document.getElementById('video-call');
      let chooseRoomButton = document.getElementById('choose-room__join');
      let roomIdInput = document.getElementById('choose-room__room-id');
      let controlBtns = document.getElementById('control');
      let audioSelect = document.getElementById('connect__select-device_audio');
      let videoSelect = document.getElementById('connect__select-device_video');
      let localVideo = document.getElementById('local-video__video');

      let joinCallerButton = document.getElementById('join__join');
      let usernameInput = document.getElementById('join__username');
      usernameInput.value = faker.name.firstName();

      let room = await jason.init_room();

      const updateLocalVideo = async function (stream) {
        localVideo.srcObject = stream;
        await localVideo.play();
      };

      audioSelect.addEventListener('change', async () => {
        try {
          const stream = await getStream(audioSelect, videoSelect);
          await updateLocalVideo(stream);
          room.inject_local_stream(stream);
        } catch (e) {
          logError("Changing audio source failed", e);
        }
      });

      videoSelect.addEventListener('change', async () => {
        try {
          const stream = await getStream(audioSelect, videoSelect);
          await updateLocalVideo(stream);
          room.inject_local_stream(stream);
        } catch (e) {
          logError("Changing video source failed", e);
        }
      });

      room.on_failed_local_stream(function (error) {
        console.error(error);
      });

      room.on_new_connection((connection) => {
        connection.on_remote_stream(async (stream) => {
          let videoDiv = document.getElementById("remote-videos");
          let video = document.createElement("video");
          video.srcObject = stream.get_media_stream();
          video.style.maxWidth = "100%";

          let innerVideoDiv = document.createElement("div");
          innerVideoDiv.className = "col-md-3";
          innerVideoDiv.appendChild(video);
          videoDiv.appendChild(innerVideoDiv);

          await video.play();
        });
      });

      let connectionState = document.getElementById('connection-state__state');
      room.on_connection_loss(async (reconnectHandle) => {
          connectionState.className = 'badge badge-warning';
          connectionState.textContent = 'Reconnecting';

          try {
              await reconnectHandle.reconnect_with_backoff(500, 2.0, 10000);
              connectionState.className = 'badge badge-success';
              connectionState.textContent = 'Connected';
          } catch (e) {
              console.error(e);
          }
      });

      room.on_close(function (on_closed) {
          connectionState.className = 'badge badge-danger';
          connectionState.textContent = "Closed";
          alert(
            `Call was ended.
            Reason: ${on_closed.reason()};
            Is closed by server: ${on_closed.is_closed_by_server()};
            Is error: ${on_closed.is_err()}.`
          );
      });

      let muteAudio = document.getElementById('control__mute_audio');
      let muteVideo = document.getElementById('control__mute_video');
      let isAudioMuted = false;
      let isVideoMuted = false;

      muteAudio.addEventListener('click', () => {
        if(isAudioMuted) {
          room.unmute_audio();
          isAudioMuted = false;
          muteAudio.textContent = "Mute audio";
        } else {
          room.mute_audio();
          isAudioMuted = true;
          muteAudio.textContent = "Unmute audio";
        }
      });
      muteVideo.addEventListener('click', () => {
        if(isVideoMuted) {
          room.unmute_video();
          isVideoMuted = false;
          muteVideo.textContent = "Mute video";
        } else {
          room.mute_video();
          isVideoMuted = true;
          muteVideo.textContent = "Unmute video";
        }
      });

      let bindJoinButtons = function (roomId) {
        joinCallerButton.onclick = async function () {
          let connectBtnsDiv = document.getElementById("join__join");
          connectBtnsDiv.style.display = 'none';
          controlBtns.style.display = 'block';

          try {
            let username = usernameInput.value;
            try {
              await axios.get(controlUrl + roomId);
            } catch (e) {
              if (e.response.status === 400) {
                console.log("Room not found. Creating new room...");
                await createRoom(roomId)
              }
            }

            await axios.delete(controlUrl + roomId + '/' + username);
            console.log("Creating new member.");
            await room.join(await addNewMember(roomId, username));
            connectionState.className = 'badge badge-success';
            connectionState.textContent = 'Connected';

          } catch (e) {
            logError("Join to room failed", e);
          }
        };
      };

      let roomId = window.location.hash.replace("#", "");

      if (roomId) {
        bindJoinButtons(roomId);
        chooseRoomDiv.style.display = "none";
        videoCallDiv.style.display = "";

        try {
          const stream = await getStream(audioSelect, videoSelect);
          await updateLocalVideo(stream);
          await getDevices(audioSelect, videoSelect, stream);
          room.inject_local_stream(stream);
        } catch (e) {
          logError("Init local video failed", e);
        }

      } else {
        chooseRoomButton.onclick = async function () {
          let roomId = roomIdInput.value;

          window.location.hash = roomId;
          bindJoinButtons(roomId);

          try {
            const stream = await getStream(audioSelect, videoSelect);
            await updateLocalVideo(stream);
            await getDevices(audioSelect, videoSelect, stream);
            room.inject_local_stream(stream);
          } catch (e) {
            logError("Init local video failed", e);
          }

          chooseRoomDiv.style.display = "none";
          videoCallDiv.style.display = "";
        };
      }
    }

    window.onload = async function () {
      await init_jason();
    };

    function logError(msg, e) {
      console.error(
        msg + ": Error[name:[", e.name(), "], ",
        "[msg:", e.message(), "], [source", e.source(), "]]",
      );
      console.error(e.trace());
    }
  </script>

</head>
<body>
  <div id="choose-room" class="input-group col-md-3">
    <input id="choose-room__room-id" type="text" class="form-control" placeholder="Room name" aria-label="Room name" aria-describedby="basic-addon2">
    <div class="input-group-append">
      <button id="choose-room__join" class="btn btn-outline-secondary" type="submit">Join Room</button>
    </div>
  </div>

  <div id="video-call" style="display: none">
    <div id="remote-videos" class="row">
    </div>

    <div class="row">
      <div class="col-md-3">
        <video id="local-video__video" muted autoplay width="100%" height="100%"></video>
      </div>
      <div class="col-md-3">

        <div class="input-group mb-3">
          <input id="join__username" type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon2">
          <div class="input-group-append">
            <button id="join__join" class="btn btn-outline-secondary" type="button">Connect</button>
          </div>
        </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <label class="input-group-text" for="connect__select-device_audio">Audio</label>
          </div>
          <select class="custom-select" id="connect__select-device_audio"></select>
        </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <label class="input-group-text" for="connect__select-device_video">Video</label>
          </div>
          <select class="custom-select" id="connect__select-device_video"></select>
        </div>

        <div id="control" class="input-group mb-3" style="display: none">
            <button class="btn btn-info" id="control__mute_audio">Mute audio</button>
            <button class="btn btn-info" id="control__mute_video">Mute video</button>
        </div>

        <div>
          <span>Connection state: </span>
          <span id="connection-state__state" class="badge badge-danger">Closed</span>
        </div>

      </div>
    </div>
  </div>
</body>
</html>
